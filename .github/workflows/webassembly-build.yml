name: Build WebAssembly

on:
  workflow_dispatch: 
  push: 
    branches: [ "main" ]
  pull_request: 
    branches: [ "main" ]

jobs:
  build-wasm:
    runs-on:  ubuntu-latest

    steps: 
    - uses: actions/checkout@v4

    - name: Setup Emscripten
      uses:  mymindstorm/setup-emsdk@v14
      with:
        version: 'latest'

    - name:  Verify Emscripten installation
      run: |
        emcc --version
        echo "EMSDK=$EMSDK"

    - name: Create wrapper CMakeLists.txt
      run: |
        cat > CMakeLists.wrapper.txt << 'EOF'
        cmake_minimum_required(VERSION 3.22)
        project(vrEmuLcdWrapper)
        add_subdirectory(${CMAKE_CURRENT_SOURCE_DIR} vrEmuLcd)
        EOF

    - name: Configure CMake with Emscripten
      run: |
        emcmake cmake -B build \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_TOOLCHAIN_FILE=$EMSDK/upstream/emscripten/cmake/Modules/Platform/Emscripten.cmake \
          -S . 

    - name: Build WebAssembly  
      run: |
        cd build && make VERBOSE=1

    - name:  List build artifacts
      run: |
        echo "Build directory contents:"
        ls -lR build/bin/ || ls -lR build/

    - name: Upload WebAssembly artifacts
      uses: actions/upload-artifact@v4
      with:
        name: wasm-binaries
        path: |
          build/bin/*
        retention-days: 30
