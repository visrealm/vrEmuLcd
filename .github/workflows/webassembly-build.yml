name: WebAssembly Build (core)

on:
  workflow_call:
    inputs:
      emsdk_version:
        description: "emsdk version to install"
        required: false
        default: "latest"
        type: string
      build_type:
        description: "CMake build type"
        required: false
        default: "Release"
        type: string
      runner:
        description: "GitHub runner label"
        required: false
        default: "ubuntu-latest"
        type: string
      generator:
        description: "CMake generator"
        required: false
        default: "Ninja"
        type: string

defaults:
  run:
    shell: bash

jobs:
  build-wasm:
    runs-on:  ${{ inputs.runner }}

    steps: 
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: Bootstrap Emscripten toolchain
      run: |
        mkdir -p build
        TOOLCHAIN=$(python tools/bootstrap_emscripten.py --emsdk-dir build/emsdk --version "${{ inputs.emsdk_version }}")
        echo "EM_TOOLCHAIN=$TOOLCHAIN" >> $GITHUB_ENV

    - name: Configure CMake (Emscripten)
      run: |
        cmake -S . -B build/wasm \
          -G "${{ inputs.generator }}" \
          -DCMAKE_TOOLCHAIN_FILE=$EM_TOOLCHAIN \
          -DCMAKE_BUILD_TYPE=${{ inputs.build_type }} \
          -DVR_EMU_LCD_BUILD_WASM=ON

    - name: Build WebAssembly
      run: cmake --build build/wasm --target vrEmuLcdWasm --config ${{ inputs.build_type }}

    - name:  List build artifacts
      run: |
        echo "Build directory contents:"
        ls -lR build/wasm/bin/ || ls -lR build/wasm/

    - name: Upload WebAssembly artifacts
      uses: actions/upload-artifact@v4
      with:
        name: wasm-binaries
        path: |
          build/wasm/bin/*
        retention-days: 30
